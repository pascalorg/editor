---
alwaysApply: true
---

# Building Editor - Project Documentation

## Overview

3D building/floor plan editor built with Next.js, React Three Fiber, and Zustand. Users create multi-floor layouts by placing walls/doors/windows/roofs on a grid, similar to The Sims build mode. Includes read-only **Viewer mode** for presentation.

## Technology Stack

### Core
- **Next.js 16** (App Router) with **React 19** and **TypeScript**
- **Bun** for package management

### 3D Rendering
- **Three.js** + **React Three Fiber (R3F)** - Declarative 3D scene management
- **@react-three/drei** - Camera controls, helpers, environment presets
- **@react-spring/three** - Smooth physics-based animations

### State & Persistence
- **Zustand** - Lightweight store with localStorage persistence, undo/redo stacks
- **IndexedDB** - Large file storage (reference images)

### UI & Styling
- **Tailwind CSS 4** - Utility-first styling
- **Shadcn UI** + **Radix UI** - Accessible component primitives
- **Lucide/Phosphor Icons**

### Development
- **Biome** - Fast linting/formatting
- **React Scan** - Performance monitoring

## Project Structure

```
app/
â”œâ”€â”€ (editor)/          # Editor route with sidebar
â””â”€â”€ viewer/            # Read-only viewer route

components/
â”œâ”€â”€ editor/            # Editor canvas, tools, grid systems, controls
â”‚   â””â”€â”€ elements/      # 3D building elements (walls, doors, windows, roofs)
â”œâ”€â”€ viewer/            # Viewer canvas and controls (read-only variants)
â”œâ”€â”€ ui/                # Shadcn/Radix UI components
â””â”€â”€ layers-menu.tsx    # Floor/layer management

hooks/
â””â”€â”€ use-editor.tsx     # Zustand store (main state)

lib/                   # Type definitions, utilities, validation logic
public/models/         # 3D models (GLB)
```

## Development

```bash
bun install            # Install dependencies
bun dev                # Start dev server (Turbopack HMR)
bun run build          # Production build
bun run lint           # Format with Biome
```

## Grid System

### Architecture
**Discrete intersection-based placement** (61Ã—61 grid points, 50cm spacing) rather than continuous placement. Grid coordinates map to world coordinates (Grid Y â†’ World Z).

### Grid Types
- **Infinite Grid**: Base floor, shader-based, fades with distance
- **Proximity Grid**: Upper floors, dynamic bounds around elements
- **Interactive Grid Tiles**: Single raycasting plane for click detection

### Interaction
- Raycasting from camera through cursor to grid plane
- Smart snapping to horizontal/vertical/45Â° axes
- Visual previews (green for build, red for delete)
- Multi-floor support (stacked vs. exploded modes)

### Performance
- Single raycasting plane (not per-intersection meshes)
- Shader-based infinite grid (no geometry)
- Memoized components, conditional rendering

## Core Architecture

### Wall Geometry
**Mitered junctions** using 2D polygon footprints + extrusion (vs. overlapping boxes) - eliminates Z-fighting, enables GLB export. Junction detection + miter point calculation for clean wall intersections.

### Coordinate System
- Grid coordinates (integer) â†’ World coordinates (float)
- Default THREE.js Y axis is the vertical axis Ground plane Y=0, X and Z axes are on the horizontal plane

## Scene Graph Architecture

#### Scene Graph
The scene graph logic and declaration for every lives `lib/graph/nodes/` live is organized as follows:

1. **Root Node** (Project Node)
   - Stores project metadata.

2. **Environment Node**
   - Stores environment-related data, such as:
     - Latitude and longitude of the site
     - North angle (X axis orientation)
     - Data for calculating real weather, time, sun exposure

3. **Site Node**
   - Contains:
     - **Terrain Node:** Stores site topography and related metadata.
     - **PropertyLines Node:** Stores the property/lot boundaries (PropertyLines may cover a smaller area than Terrain).

4. **Building Node**
   - Represents a single building structure.

5. **Level Nodes** (children of Building Node)
   - Each level (floor) of the building is represented by a Level node.

6. **Building Elements at Each Level**
   - Elements such as Walls, Floors, Columns, and Ceilings are direct children of Level nodes.
   - These elements are managed in the Level node's hierarchy similarly to layers in Photoshop/Figma:
     - The sidebar determines their visibility stacking order.
     - Vertically, they stack according to building logic (e.g., Floor -> Wall -> Ceiling).

#### NODE HIERARCHY:
Root (Root node)
â”œâ”€â”€ â˜€ï¸ Environment   (Sky, Sun, etc.)
â”œâ”€â”€ ğŸŒ³ Site
â”‚   â”œâ”€â”€ PropertyNode (Type "": 2D/3D polygon)
â”‚   â”œâ”€â”€ Terrain (Type "terrain": 3D topography mesh)
â”‚   â””â”€â”€ ğŸŒ¿ Landscape (Type "Group")
â”‚       â”œâ”€â”€ Softscape (Type "softscape": trees, shrubs, lawns glTF)
â”‚       â”‚   â”œâ”€â”€ Tree_1 (Type "Plant")
â”‚       â”‚   â””â”€â”€ Plant_1 (Type "Plant")
â”‚       â”œâ”€â”€ ğŸª¨ Hardscape (Type "hardscape": rocks, gravel, paths, walls glTF)
â”‚       â”‚   â”œâ”€â”€ Rock_1 (Type "Rock")
â”‚       â”‚   â””â”€â”€ Boulder_1 (Type "Rock")
â”‚       â””â”€â”€ ğŸ’§ Waterscape (Type "waterscape": ponds, pools, fountains glTF)
â”‚           â”œâ”€â”€ Pond_1 (Type "Water")
â”‚           â””â”€â”€ Fountain_1 (Type "Water")
â”‚
â””â”€â”€ ğŸ¢ BuildingNode (Type "building")
    â”œâ”€â”€ LevelNode (Type "level")
    â”‚   â”œâ”€â”€ Floor_Slab_1_1 (Type "Floor")
    â”‚   â”œâ”€â”€ Ceiling_Slab_1_1 (Type "Ceiling")
    â”‚   â”‚   â”œâ”€â”€ Light_Fixture_1 (parent "Ceiling_Slab_1_1")
    â”‚   â”‚   â””â”€â”€ AC_Return_1 (parent "Ceiling_Slab_1_1")
    â”‚   â”œâ”€â”€ Wall_1_1 (Type "Wall")
    â”‚   â”‚   â””â”€â”€ Window_1_1 (Type "Window", parent "Wall_1_1")
    â”‚   â”œâ”€â”€ Wall_1_2 (Type "Wall")
    â”‚   â”‚   â””â”€â”€ Door_1_1 (Type "Door", parent "Wall_1_2")
    â”‚   â”œâ”€â”€ Wall_1_3 (Type "Wall")
    â”‚   â”œâ”€â”€ ğŸ›‹ï¸ Kitchen_Group (Type "Group")
    â”‚   â”‚   â”œâ”€â”€ Countertop_1 (parent "Kitchen_Group")
    â”‚   â”‚   â”œâ”€â”€ Fridge_1 (parent "Kitchen_Group")
    â”‚   â”‚   â””â”€â”€ Stove_1 (parent "Kitchen_Group")
    â”‚   â”œâ”€â”€ Couch_1 (Type "Furniture", parent "Level_1")
    â”‚   â””â”€â”€ Stair_to_L2 (Type "Stair", parent "Level_1")
    â”‚
    â”œâ”€â”€ Level_2 (Type "Level")
    â”‚   â”œâ”€â”€ Floor_Slab_2_1 (Type "Floor")
    â”‚   â”œâ”€â”€ Ceiling_Slab_2_1 (Type "Ceiling")
    â”‚   â”‚   â””â”€â”€ Fan_1 (parent "Ceiling_Slab_2_1")
    â”‚   â””â”€â”€ ğŸ  Rooftop_Patio_Elements (Type "Group", parent "Level_2")
    â”‚       â””â”€â”€ Patio_Roof (Type "Roof", parent "Rooftop_Patio_Elements")
    â”‚
    â””â”€â”€ Top_Level (Type "Level")
        â”œâ”€â”€ Floor_Slab_3_1 (e.g., attic floor)
        â””â”€â”€ ğŸ  Main_Roof_Group (Type "Group", parent "Top_Level")
            â”œâ”€â”€ Gable_Roof_1 (Type "Roof")
            â””â”€â”€ Jerkin_Roof_1 (Type "Roof")
