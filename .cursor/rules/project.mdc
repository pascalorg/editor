---
alwaysApply: true
---
I am updating the project documentation to reflect the current codebase structure, including providers, sidebar, context, and editor components for better guidance to future developers and AI agents.

# House Builder Project

## Project Overview
A 3D house builder inspired by The Sims' building mode. Users place walls between grid intersections using point-to-point placement, creating line segments that extrude into 3D walls in an isometric view. Features four control modes (Select/Delete/Building/Guide), multiple building tools (Wall, Room, Custom Room), reference image overlays with interactive manipulation, and GLB export.

**Stack**: React 19, Next.js 15, React Three Fiber, Three.js, Zustand, Drei, Leva, Shadcn UI, Tailwind v4.

**3D Coordinate System**: Uses Three.js default orientation - XZ plane for floor (ground), Y-axis for vertical (up).

**Key Libraries**:
- **Zustand**: Global state with persistence and undo/redo (50-state stack)
- **Drei**: Grid, OrbitControls, GizmoHelper, Environment
- **Leva**: Real-time parameter controls (wall height, tile size, grid opacity)
- **Shadcn UI**: Buttons, tooltips, dialogs
- **Phosphor Icons**: Building tool icons

## Core Features

### Control Modes (Top-Center Menu)
- **Select (V)**: Click walls to select, Shift+click for multi-selection, right-click context menu. Left-click+drag pans camera.
- **Delete (D)**: Two-click line deletion - click two intersections to remove overlapping wall segments. Left-click reserved for deletion (camera pan via middle-click only).
- **Building (B)**: Auto-activated when selecting a building tool. Left-click reserved for placement (camera pan via middle-click only).
- **Guide (G)**: Interactive reference image manipulation mode - click images to select, drag 3D handles to transform. Left-click reserved for image manipulation (camera pan via middle-click only).
- **Camera Controls**: All modes support middle-click pan, right-click rotate, scroll wheel zoom
- **Shortcuts**: `Esc` to cancel, `V/D/B/G` to switch modes, `Space` for orbit controls

### Building Tools (Bottom-Center Menu)
- **Wall**: Two-click placement with smart snapping (H/V/45° diagonal), green preview + shadow
- **Room**: Two-click rectangle (creates 4 walls instantly)
- **Custom Room**: Multi-click polygon - click to add points, click first point to close, double-click to finish open
- **Door/Window**: Stubbed (future implementation)

### Grid System
- **30m × 30m** area, **61×61 intersections** (50cm spacing)
- Walls are **line segments** between intersections, supports H/V/diagonal
- Visual feedback: down arrows at hover, green previews, start point spheres
- Group offset: `[−15, 0, −15]` centers grid at world origin

### 3D Scene (Isometric View)
- **Camera**: [10,10,10] perspective (FOV 50) or orthographic (zoom 20)
- **Lighting**: Ambient (0.5) + directional ([10,10,5]) with shadows
- **Walls**: BoxGeometry (20cm thick), colors: default #aaaabf, selected #ff8888, hovered #ff6b6b
- **Drei Grid**: 50cm cells, 5-cell sections highlighted, adjustable opacity
- **Axes**: Infinite dashed X/Y/Z lines (subtle)

### Editing Features
- **Undo/Redo**: `Cmd/Ctrl+Z` / `Cmd/Ctrl+Shift+Z` (50-state stack)
- **Reference Images**: Multiple PNG/JPEG overlays with per-image position, rotation (Y-axis), and scale. In Guide mode, interactive 3D handles appear on selected images for direct manipulation
- **GLB Export**: Download walls group as binary GLB
- **Layout Files**: Save/load as JSON (version 2.0, segment-based)

## File Structure & Key Components

### State Management (`hooks/use-editor.tsx`)
**Zustand store** with localStorage persistence and Set-based API for components.

**Core State**:
- `walls`: Array<string> - wall keys ("x1,y1-x2,y2")
- `images`: Array<ReferenceImage> - each with id, url, name, createdAt, position [x,z], rotation (degrees), scale
- `selectedWallIds`, `selectedImageIds`: Arrays for selection
- `activeTool`: 'wall' | 'room' | 'custom-room' | null
- `controlMode`: 'select' | 'delete' | 'building' | 'guide'
- `undoStack`, `redoStack`: Max 50 states each
- `wallsGroupRef`: Three.js Group for export

**Key Methods**:
- `wallSegments()`: Computes `{ start: [x,y], end: [x,y], id, isHorizontal }[]` from wall keys
- `setActiveTool()`: Auto-switches to building mode
- `serializeLayout()` / `loadLayout()`: JSON persistence (version 2.0)
- `undo()` / `redo()`: Stack-based history
- `getWallsSet()`: Array → Set conversion for O(1) lookups

### Main Editor (`components/editor/index.tsx`)
**Constants**: `TILE_SIZE=0.5`, `WALL_HEIGHT=2.5`, `WALL_THICKNESS=0.2`, `GRID_SIZE=30`, `GRID_INTERSECTIONS=61`

**Local State**: Placement previews for each tool (`wallStartPoint`, `roomStartPoint`, `customRoomPoints`, `deleteStartPoint`), camera/context menu state

**Key Handlers**:
- `handleIntersectionClick`: Routes to wall/room/custom-room/delete based on mode
- `handleIntersectionHover`: Smart snapping to H/V/45° axes
- `handleDeleteWallPortion`: Line overlap detection with `getOverlappingSegment()`
- `handleIntersectionDoubleClick`: Finishes custom-room without closing

**Keyboard**: `Esc` cancel, `V/D/B/G` modes, `Space` orbit, `Cmd/Ctrl+Z` undo

**Canvas**: Group offset `[−15,0,−15]` centers grid, renders GridTiles + Walls + ReferenceImage + CustomControls

### UI Components
**`control-mode-menu.tsx`**: Top-center, 4 buttons (Select/Delete/Building/Guide), color-coded active state (blue/red/green/purple), tooltips with shortcuts

**`building-menu.tsx`**: Bottom-center, tool buttons with Phosphor icons, click to activate/deactivate, auto-switches mode

**`elements/grid.tsx`**: Raycasting plane, down arrow hover indicators, preview rendering (green for build, red for delete), snapping logic

**`elements/wall.tsx`**: BoxGeometry meshes, `atan2(-dz, dx)` rotation for any angle, color states (default/hover/selected), WallShadowPreview component

**`elements/reference-image.tsx`**: Plane mesh with texture, per-image transforms (position, rotation, scale). In Guide mode, displays 3D manipulation handles when selected:
- **Translation handles**: White arrow-cylinder pairs at center for X/Z movement (aligned to image rotation)
- **Rotation handles**: White quarter-torus arcs at each corner for Y-axis rotation
- **Scale handles**: White cylinders at edge midpoints for uniform scaling from center

**`custom-controls.tsx`**: CameraControls wrapper with mode-aware mouse button configuration. Dynamically adjusts camera controls based on `controlMode`:
- **Select mode**: Left-click+drag pans camera (TRUCK), full camera controls available
- **Delete/Build/Guide modes**: Left-click disabled for camera (ACTION.NONE) - reserved for mode-specific actions (deletion, placement, image manipulation)
- **All modes**: Middle-click+drag pans (SCREEN_PAN), right-click+drag rotates (ROTATE), scroll wheel zooms (DOLLY)
- Polar angle constrained to 0-π/2 (overhead isometric view), distance 10-50 units

### Key Flows

**Wall Placement**: Tool selection → first click stores start → hover shows preview → second click creates segment → `setWalls()` updates + pushes undo

**Deletion**: 
- Select mode: Click wall → right-click → context menu
- Delete mode: Two clicks define line → `getOverlappingSegment()` calculates overlaps → removes/splits walls

**Reference Image Manipulation**:
- Upload via sidebar → images persist with position [0,0], rotation 0°, scale 1
- Guide mode: Click image → select → white 3D handles appear
- Drag translate arrows (X/Z), rotation arcs (corners), or scale handles (edges)
- Real-time updates via `onUpdate()` callback → `setImages()` → localStorage sync
- Click grid to deselect

**Mode Switching**: `setActiveTool()` auto-switches to building, `Esc` cancels operations

**Persistence**: `serializeLayout()` → JSON download, `loadLayout()` → parse + `setWalls()`, localStorage auto-sync via Zustand

**Undo/Redo**: Stack-based (max 50), triggered by `setWalls()`, `Cmd/Ctrl+Z` navigates history

## Design Decisions

### Sims-Inspired Choices
- **Multi-Mode System**: Separate Select/Delete/Building modes (like The Sims) vs. single mode with modifiers - clearer mental model
- **Intersection-Based Walls**: Line segments between grid points vs. tile fills - supports diagonals, matches real blueprints, cleaner state
- **Smart Snapping**: Auto-snaps to H/V/45° axes - prevents messy off-axis walls, matches Sims behavior
- **Visual Previews**: Green shadows for placement, red planes for deletion - see before committing, reduces mistakes
- **Isometric View**: Camera at [10,10,10] polar 0-π/2 - classic Sims-style overhead perspective

### Technical Choices
- **Zustand Over Context**: Better performance, built-in persistence, simpler API, undo/redo via stacks
- **Geometric Deletion**: Line overlap detection - precisely cut/remove wall portions (like Sims demolish tool)
- **Drei Grid + Custom Raycasting**: Drei for visuals, custom plane for clicks - Drei Grid is visual-only
- **Memoized Components**: React.memo on GridTiles/Walls/Previews - smooth 60fps with hundreds of walls
- **HTML Context Menu**: Overlay div vs. R3F component - reliable pointer coords
- **Keyboard Shortcuts**: V/D/B/G/Esc/Space/Z - CAD/Sims-inspired power user workflow
- **Versioned JSON**: Schema v2.0 with segment-based format - extensible for doors/windows/furniture
- **Direct Manipulation Handles**: 3D gizmos for reference images - raycasting + pointer events for intuitive transformations, handles scale inversely to image scale for consistent size
- **Mode-Aware Camera Controls**: Dynamic mouse button configuration - left-click reserved for mode actions (delete/build/guide) vs. camera panning (select), prevents conflicts between camera and tool interactions

## Data Persistence & JSON Structure

### JSON Schema (Version 2.0)

```typescript
type WallSegment = { start: [x, y], end: [x, y], id: string, isHorizontal: boolean }
type Component = { id, type: 'wall', label, group, data: { segments }, createdAt }
type ComponentGroup = { id, name, type: 'room' | 'floor' | 'outdoor', color }
type LayoutJSON = { version: "2.0", grid: { size: 61 }, components, groups }
```

**Example**:
```json
{
  "version": "2.0",
  "grid": { "size": 61 },
  "components": [{
    "id": "walls-default",
    "type": "wall",
    "data": {
      "segments": [
        { "start": [10, 10], "end": [20, 10], "id": "10,10-20,10", "isHorizontal": true }
      ]
    }
  }]
}
```

### Save/Load Flow
- **Save**: `serializeLayout()` → wallSegments() → JSON Blob → download `layout_YYYY-MM-DD.json`
- **Load**: File upload → parse JSON → `loadLayout()` → map segments to wall keys → `setWalls()`
- **Storage**: Zustand persist middleware auto-syncs to localStorage
- **Sidebar**: Save/Load buttons + JSON inspector dialog with `@uiw/react-json-view`

### Schema Extensibility

The JSON schema supports future component types:
- **Multiple component types**: Add `type: 'door' | 'window' | 'furniture'` with type-specific data
- **Component grouping**: Assign components to groups for room/floor organization
- **Materials**: Add `material` field to components (wood, brick, glass textures)
- **Transformations**: Store position, rotation, scale per component
- **Metadata**: User notes, tags, version history, cost estimates

**Example Future Component (Door)**:
```json
{
  "id": "door-1",
  "type": "door",
  "label": "Front Door",
  "group": "living-room",
  "data": {
    "parentWall": "10,10-20,10",
    "position": [15, 10],
    "width": 0.9,
    "height": 2.1,
    "swingDirection": "inward",
    "material": "wood",
    "hingeLocation": "left"
  },
  "createdAt": "2025-10-22T12:30:00Z"
}
```

## Future Enhancements

Potential additions include: doors/windows with wall cutouts, room detection via flood-fill, multi-floor support, wall types/materials, measurements/labels, component library, mobile support, backend sync for collaboration, and various export formats (DXF/DWG/OBJ).

